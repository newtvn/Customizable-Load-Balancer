from random import randint

class ConsistentHash:
    
    slots : int = 512
    num_virtual_servers :  int = 9
    servers : dict[int , str]
    hashmap : list[any]


    
    def __init__(self):
        self.slots = slots
        self.hashmap = [None] * self.slots

    def request_hash(self, i : int ) -> int:
        return ((i**2) + (2*i) + 17 ) % self.slots

    def server_hash(self, i : int, j : int) -> int:
        return ((i**2)+(j**2)+(2*j)+ 25) % self.slots

    def generate_server_id(self, server_name : str) -> int:
        while True:
            id =  randint(1000, 9999)
            if id not in self.servers:
                self.servers[id] = server_name
                return id

    def get_server_id(self, server_name : str) -> int:
        return list(self.servers.keys())[list(self.servers.values()).index(server_name)]

    def add_server(self, server_name : str) -> int:
        server_id = self.generate_server_id(server_name)
        for j in range(self.num_virtual_servers) :
            position = self.server_hash(server_id,j)
            if self.hashmap[position] is None:
                self.hashmap[position] = {'server' : server_id} 
            else:
                while self.hashmap[position] is not None:
                    position = (position + 1) % self.slots
                    if self.hashmap[position] is None:
                        self.hashmap[position] = {'server' : server_id}
        return server_id
                        

    
    def remove_server(self,server_name : str):
        for pos in range(self.slots):
            if 'server' in self.hashmap[pos]:
                if self.hashmap[pos]['server'] == self.get_server_id(server_name) :
                    self.hashmap[pos] = None
        return True
    
    def add_request(self, request_id : int) -> int:
        position = self.request_hash(request_id)
        if self.hashmap[position] is None:
            self.hashmap[position] = {'request' : request_id} 
        else:
            while self.hashmap[position] is not None:
                position = (position + 1) % self.slots
                if self.hashmap[position] is None:
                    self.hashmap[position] = {'request' : request_id}

        while 'server' not in self.hashmap[position]:
            position = (position + 1) % self.slots
        
        return self.hashmap[position]['server']
    
    def complete_request(request_id : int):
        for pos in range(self.slots):
            if 'request' in self.hashmap[pos]:
                if self.hashmap[pos]['request'] == request_id:
                    self.hashmap[pos] = None
        return True

        
    
